<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mapa - CEBRI</title>
    <style>
      /* --- ESTILOS GERAIS --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        outline: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f4f9;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        overflow: hidden;
        overscroll-behavior: none;
      }

      /* --- LOADER --- */
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #333;
        display: none;
      }
      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #293e50;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- MENU DE SELEÇÃO --- */
      #menu-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        position: absolute;
        background: #ececec;
        z-index: 50;
        padding: 20px;
      }

      .menu-logo {
        width: 500px;
        max-width: 100%;
        height: auto;
        margin-bottom: 40px;
      }

      .menu-btn {
        background-color: #293e50;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 15px;
        width: 100%;
        max-width: 300px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, background-color 0.2s;
      }

      .menu-btn:hover {
        background-color: #1f2f3d;
        transform: translateY(-2px);
      }

      /* --- TELA DO MAPA --- */
      #map-screen {
        display: none;
        width: 100%;
        height: 100%;
        position: relative;
        background-color: #cdcdcd;
      }

      .hidden {
        display: none !important;
      }

      /* Barra Superior */
      .top-bar {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
        display: flex;
        gap: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 8px 15px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
      }
      .btn-reset {
        background-color: #0056b3;
      }

      .instructions {
        font-size: 0.8rem;
        color: #555;
        margin-left: 10px;
        display: flex;
        align-items: center;
      }

      #map-title {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 90;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        font-weight: bold;
        color: #333;
        font-size: 1rem;
        max-width: 200px;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Legenda */
      .legend-container {
        position: absolute;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 110;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .legend-header {
        background: #eee;
        padding: 12px;
        font-weight: bold;
        text-align: center;
        border-bottom: 1px solid #ccc;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .legend-header::after {
        content: "▼";
        font-size: 0.8rem;
        transition: transform 0.3s;
      }
      .legend-container.collapsed .legend-header::after {
        transform: rotate(-90deg);
      }
      .legend-container.collapsed .legend-list {
        display: none;
      }
      .legend-container.collapsed {
        height: auto;
      }

      .legend-list {
        overflow-y: auto;
        padding: 0;
        margin: 0;
        list-style: none;
      }

      .legend-item {
        padding: 10px 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .legend-item:hover {
        background-color: #f9f9f9;
      }
      .legend-item.active {
        background-color: #0056b3;
        color: white;
        font-weight: bold;
      }

      /* RESPONSIVIDADE */
      @media (min-width: 769px) {
        .legend-container {
          top: auto;
          bottom: 20px;
          left: auto;
          right: 20px;
          width: 260px;
          max-height: 50%;
        }
        .legend-header::after {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .top-bar {
          top: 0;
          left: 0;
          width: 100%;
          border-radius: 0;
          padding: 5px;
          justify-content: space-between;
        }
        .control-btn {
          padding: 6px 10px;
          font-size: 0.8rem;
        }
        .instructions {
          display: none;
        }
        #map-title {
          top: 50px;
          right: 10px;
          background: rgba(255, 255, 255, 0.8);
          font-size: 0.8rem;
        }
        .legend-container {
          bottom: 0;
          left: 0;
          right: 0;
          top: auto;
          width: 100%;
          border-radius: 15px 15px 0 0;
          max-height: 50%;
        }
        .legend-list {
          max-height: 40vh;
        }
      }

      /* VIEWPORT DO MAPA */
      .map-viewport {
        width: 100%;
        height: 100%;
        overflow: hidden;
        cursor: grab;
        position: relative;
        touch-action: none;
      }
      .map-viewport:active {
        cursor: grabbing;
      }

      .map-content {
        position: absolute;
        top: 0;
        left: 0;
        transform-origin: 0 0;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        background-color: white;
        will-change: transform;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      .map-content.loaded {
        opacity: 1;
      }

      .map-image {
        display: block;
        width: 100%;
        height: 100%;
        pointer-events: none;
        image-rendering: -webkit-optimize-contrast;
      }

      .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
      }

      .room {
        fill: rgba(100, 255, 100, 0.15);
        stroke: #333;
        stroke-width: 2px;
        cursor: pointer;
        vector-effect: non-scaling-stroke;
        transition: fill 0.1s;
      }
      .room:hover,
      .room:active {
        fill: rgba(255, 140, 0, 0.6);
        stroke: #000;
        stroke-width: 5px;
      }
      .room.active {
        fill: rgba(255, 140, 0, 0.8) !important;
        stroke: #000 !important;
        stroke-width: 5px !important;
      }
      .map-border {
        fill: none;
        stroke: #000;
        stroke-width: 5px;
        pointer-events: none;
        vector-effect: non-scaling-stroke;
      }

      #tooltip {
        position: fixed;
        display: none;
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        pointer-events: none;
        z-index: 200;
      }
    </style>
  </head>
  <body>
    <div id="loader">
      <div class="spinner"></div>
      <div>Carregando Mapa...</div>
    </div>

    <div id="menu-screen">
      <img src="TelaLogoCEBRI.png" alt="CEBRI Logo" class="menu-logo" />
      <button class="menu-btn" onclick="iniciarMapa('terreo')">Térreo</button>
      <button class="menu-btn" onclick="iniciarMapa('pavimento1')">
        1º Andar
      </button>
    </div>

    <div id="map-screen">
      <div class="top-bar">
        <div>
          <button class="control-btn" onclick="fecharMapa()">← Voltar</button>
          <button class="control-btn btn-reset" onclick="centralizarMapa()">
            ⟲ Centralizar
          </button>
        </div>
        <div class="instructions">(Scroll p/ Zoom | Arraste p/ Mover)</div>
      </div>

      <div id="map-title">Título do Mapa</div>

      <div class="legend-container" id="legend-container">
        <div class="legend-header" onclick="toggleLegenda()">Legenda</div>
        <ul id="legend-list" class="legend-list"></ul>
      </div>

      <div class="map-viewport" id="viewport">
        <div class="map-content" id="map-content">
          <img id="img-fundo" src="" class="map-image" decoding="async" />
          <svg
            id="svg-overlay"
            class="map-overlay"
            xmlns="http://www.w3.org/2000/svg"
          ></svg>
        </div>
      </div>
    </div>

    <div id="tooltip"></div>

    <script>
      // DADOS
      const dados = {
        terreo: {
          titulo: "Térreo",
          imagem: "terreo.png",
          viewBox: "0 0 9918 7011",
          paths: `
            <path class="room" data-nome="Anexo/Hospedaria" d="M1443 3237L1156.5 3184.5L1154 5022.5L1607.5 5000L1443 3237Z"/>
            <path class="room" data-nome="Corredor Anexo" d="M1443 3220L1226.5 3181L1284.5 3005.5L2774 3144V3344L1443 3189.5V3220Z"/>
            <path class="room" data-nome="Deck" d="M2767 2515V2336.5L3184.5 2147.5H3618.5L4363 1944.5V2515H2767Z"/>
            <path class="room" data-nome="Hall 02" d="M2985 3144H2784V3411H2985V3144Z"/>
            <path class="room" data-nome="Sala da JDL" d="M3357.5 3131H2784V2530H3357.5V3131Z"/>
            <path class="room" data-nome="Sala de TI" d="M3357.5 3144H3002V3411H3357.5V3144Z"/>
            <path class="room" data-nome="Sala do Conselho" d="M4363 2530H3370V3150H4363V2530Z"/>
            <path class="room" data-nome="Auditório" d="M3370 4043V3173.5H4701L4698.5 4086.5L3370 4043Z"/>
            <path class="room" data-nome="Salão Principal" d="M4698.5 4130L3370 4086.5V4707.5H4698.5V4130Z"/>
            <path class="room" data-nome="Banheiro 02" d="M4632 2515H4380.5V2767H4632V2515Z"/>
            <path class="room" data-nome="Banheiro 01" d="M4632 2785.5H4380.5V2959.5H4632V2785.5Z"/>
            <path class="room" data-nome="Banheiro 03 (PCD)" d="M4973 2348.5H4647.5V2576.5H4973V2348.5Z"/>
            <path class="room" data-nome="Hall 01" d="M4973 2593.5H4647.5L4644.5 2970H4380.5V3162.5H4973V2593.5Z"/>
            <path class="room" data-nome="Copa" d="M5289.5 2533H4999.5V3173.5H5289.5V2533Z"/>
            <path class="room" data-nome="Cozinha" d="M6150.5 2050V2515H4991.5V2339H5053V2084H5983.5V2050H6150.5Z"/>
            <path class="room" data-nome="Material de Escritório" d="M4662.5 2084H5045V2330H4985.5H4662.5V2084Z"/>
            <path class="room" data-nome="Hall de Serviço" d="M6165.5 2367V2050H6400V2367H6165.5Z"/>
            <path class="room" data-nome="Depósito" d="M6400 2382.5H6165.5V2502H6400V2382.5Z"/>
            <path class="room" data-nome="Sala de Reunião Claudia Jaguaribe" d="M6417 2502V2050H7102.5V2502H6417Z"/>
            <path class="room" data-nome="Sala de Exposição Claudia Jaguaribe" d="M7004.5 2533H5308V3176.5H7004.5V2533Z"/>
            <path class="room" data-nome="Escada" d="M7387.5 2668.5H7034.5V3188H7387.5V2668.5Z"/>
            <path class="room" data-nome="Elevador" d="M7017.5 3663.5V3480H7218V3663.5H7017.5Z"/>
            <path class="room" data-nome="Varanda" d="M7218 3202.5V3456L4969 3436.5V4985H3075V3429.5H3353V4729H4715.5V3202.5H7218Z"/>
            <path class="room" data-nome="Capela" d="M8054.5 2954.5V1958H9039.5V2954.5H8054.5Z"/>
            <path class="map-border" d="M0.5 7010V0.500732L9917 13.0007V7010H0.5Z"/>
            <path class="room" data-nome="Pátio Externo" d="M2771 3431H3070L3069 4992H2698.5V4887.5H2511V4992H2194V4786H1836V4713H1630V3388H2771V3431Z"/>
          `,
        },
        pavimento1: {
          titulo: "1º Andar",
          imagem: "pavimento1.png",
          viewBox: "0 0 9942 7016",
          paths: `
            <path class="room" data-nome="Banheiro 06" d="M3820.5 3602.5H3573V3751.5H3820.5V3602.5Z"/>
            <path class="room" data-nome="Banheiro 07" d="M3820.5 3771H3573V3908H3820.5V3771Z"/>
            <path class="room" data-nome="Banheiro 08" d="M4034 3771H3834.5V3908H4034V3771Z"/>
            <path class="room" data-nome="Sala Fechada" d="M4034 3602.5H3834.5V3751.5H4034V3602.5Z"/>
            <path class="room" data-nome="Sala da Diretoria" d="M3573 4510V3928.5H4034V4510H3573Z"/>
            <path class="room" data-nome="Open Space" d="M4039 3000H2757L2761.5 4508H3562V3586.5H4039V3000Z"/>
            <path class="room" data-nome="Sala Adm/Fin/RH" d="M2751 2368.5H3293.5V2838.5H3393V2984.5H2751V2368.5Z"/>
            <path class="room" data-nome="Sala de Reunião" d="M3309.5 2820V2368.5H3737.5V2820H3309.5Z"/>
            <path class="room" data-nome="Hall 03" d="M4353 2368.5H3755.5V2838.5H3413.5V2984.5L4340 2982L4353 2368.5Z"/>
            <path class="room" data-nome="Varanda" d="M6582 3024.5L4080.5 3005.5V3256H6582V3024.5Z"/>
            <path class="room" data-nome="Elevador" d="M6582 3266H6384.5V3476.5H6582V3266Z"/>
            <path class="room" data-nome="Escada" d="M6755.5 3011.5H6403V2481.5H6755.5V3011.5Z"/>
            <path class="room" data-nome="Copa" d="M6384.5 2347V3011.5H6059V2470.5H5875V2347H6384.5Z"/>
            <path class="room" data-nome="Banheiro 04" d="M5871.5 3011.5H6043.5V2739.5H5871.5V3011.5Z"/>
            <path class="room" data-nome="Banheiro 05" d="M5871.5 2722H6043.5V2488.5H5875L5871.5 2722Z"/>
            <path class="room" data-nome="Sala de Projetos" d="M5854 2347H4390V2982H5854V2347Z"/>
            <path class="map-border" d="M0.5 7015V0.500122L9941 3.00012V7015H0.5Z"/>
          `,
        },
      };

      // --- ESTADO ---
      let scale = 1;
      let pointX = 0;
      pointY = 0;
      let isDragging = false;
      let startX = 0;
      startY = 0;

      // Variáveis para Pinch (Zoom de dois dedos)
      let initialPinchDistance = 0;
      let initialScale = 1;

      const viewport = document.getElementById("viewport");
      const mapContent = document.getElementById("map-content");
      const mapImage = document.getElementById("img-fundo");
      const loader = document.getElementById("loader");
      const tooltip = document.getElementById("tooltip");
      const menuScreen = document.getElementById("menu-screen");
      const mapScreen = document.getElementById("map-screen");
      const legendList = document.getElementById("legend-list");
      const legendContainer = document.getElementById("legend-container");

      function iniciarMapa(tipo) {
        const info = dados[tipo];
        if (!info) return;

        loader.style.display = "flex";
        menuScreen.classList.add("hidden");

        scale = 1;
        pointX = 0;
        pointY = 0;
        legendList.innerHTML = "";
        mapContent.classList.remove("loaded");

        if (window.innerWidth <= 768) {
          legendContainer.classList.add("collapsed");
        } else {
          legendContainer.classList.remove("collapsed");
        }

        const viewBoxValues = info.viewBox.split(" ").map(Number);
        const mapWidth = viewBoxValues[2];
        const mapHeight = viewBoxValues[3];

        document.getElementById("map-title").innerText = info.titulo;

        // TROCA INTELIGENTE DE IMAGEM
        let imageSrc = info.imagem;
        if (window.innerWidth <= 768) {
          imageSrc = imageSrc.replace(".png", ".webp");
        }
        mapImage.src = imageSrc;

        mapContent.style.width = mapWidth + "px";
        mapContent.style.height = mapHeight + "px";

        const svg = document.getElementById("svg-overlay");
        svg.setAttribute("viewBox", info.viewBox);
        svg.innerHTML = info.paths;

        gerarLegenda(svg);

        mapImage.onload = () => {
          loader.style.display = "none";
          mapScreen.style.display = "block";
          mapContent.classList.add("loaded");
          centralizarMapa(mapWidth, mapHeight);
        };

        if (mapImage.complete) {
          mapImage.onload();
        }

        configurarInteratividade();
      }

      function fecharMapa() {
        mapScreen.style.display = "none";
        menuScreen.classList.remove("hidden");
        tooltip.style.display = "none";
        mapImage.src = "";
      }

      function toggleLegenda() {
        legendContainer.classList.toggle("collapsed");
      }

      function gerarLegenda(svgElement) {
        const rooms = Array.from(svgElement.querySelectorAll(".room"));
        rooms.sort((a, b) => {
          const nomeA = a.getAttribute("data-nome").toUpperCase();
          const nomeB = b.getAttribute("data-nome").toUpperCase();
          return nomeA < nomeB ? -1 : nomeA > nomeB ? 1 : 0;
        });

        rooms.forEach((room) => {
          const nome = room.getAttribute("data-nome");
          const li = document.createElement("li");
          li.className = "legend-item";
          li.textContent = nome;
          li.setAttribute("data-target-nome", nome);

          li.addEventListener("click", () => {
            selecionarSalaPorNome(nome);
          });
          legendList.appendChild(li);
        });
      }

      function selecionarSalaPorNome(nomeAlvo) {
        const svgRoom = document.querySelector(
          `.room[data-nome="${nomeAlvo}"]`
        );
        const legendItem = document.querySelector(
          `.legend-item[data-target-nome="${nomeAlvo}"]`
        );

        if (!svgRoom || !legendItem) return;

        const estaAtivo = svgRoom.classList.contains("active");

        document
          .querySelectorAll(".room")
          .forEach((r) => r.classList.remove("active"));
        document
          .querySelectorAll(".legend-item")
          .forEach((l) => l.classList.remove("active"));

        if (!estaAtivo) {
          svgRoom.classList.add("active");
          legendItem.classList.add("active");
          legendItem.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      }

      function configurarInteratividade() {
        const rooms = document.querySelectorAll(".room");
        rooms.forEach((room) => {
          room.addEventListener("mousemove", (e) => {
            const nome = e.target.getAttribute("data-nome");
            tooltip.innerText = nome;
            tooltip.style.display = "block";
            tooltip.style.left = e.clientX + 15 + "px";
            tooltip.style.top = e.clientY + 15 + "px";
          });

          room.addEventListener("mouseleave", () => {
            tooltip.style.display = "none";
          });

          room.addEventListener("click", (e) => {
            if (isDragging) return;
            const nome = e.target.getAttribute("data-nome");
            selecionarSalaPorNome(nome);
          });

          room.addEventListener(
            "touchstart",
            (e) => {
              if (e.touches.length > 1) return;
              if (isDragging) return;
              const nome = e.target.getAttribute("data-nome");
              tooltip.innerText = nome;
              tooltip.style.display = "block";
              const touch = e.touches[0];
              tooltip.style.left = touch.clientX + 10 + "px";
              tooltip.style.top = touch.clientY - 30 + "px";
            },
            { passive: true }
          );
        });
      }

      function updateTransform() {
        mapContent.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
      }

      function centralizarMapa(w, h) {
        if (!w) w = parseFloat(mapContent.style.width);
        if (!h) h = parseFloat(mapContent.style.height);

        const rectViewport = viewport.getBoundingClientRect();
        const scaleX = rectViewport.width / w;
        const scaleY = rectViewport.height / h;
        scale = Math.min(scaleX, scaleY) * 0.95;

        pointX = (rectViewport.width - w * scale) / 2;
        pointY = (rectViewport.height - h * scale) / 2;
        updateTransform();
      }

      // Funções auxiliares para matemática de distância
      function getDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.hypot(dx, dy);
      }

      function getMidpoint(touch1, touch2) {
        return {
          x: (touch1.clientX + touch2.clientX) / 2,
          y: (touch1.clientY + touch2.clientY) / 2,
        };
      }

      // MOUSE WHEEL (Desktop Zoom)
      viewport.addEventListener(
        "wheel",
        (e) => {
          e.preventDefault();
          const delta = -Math.sign(e.deltaY);
          const step = 0.15;
          const nextScale = scale + delta * step * scale;
          if (nextScale > 5 || nextScale < 0.05) return;

          const rect = viewport.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;
          const contentX = (mouseX - pointX) / scale;
          const contentY = (mouseY - pointY) / scale;

          pointX = mouseX - contentX * nextScale;
          pointY = mouseY - contentY * nextScale;
          scale = nextScale;
          updateTransform();
        },
        { passive: false }
      );

      // MOUSE DRAG
      viewport.addEventListener("mousedown", (e) => {
        isDragging = true;
        startX = e.clientX - pointX;
        startY = e.clientY - pointY;
        viewport.style.cursor = "grabbing";
      });

      window.addEventListener("mouseup", () => {
        isDragging = false;
        viewport.style.cursor = "grab";
      });

      window.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        e.preventDefault();
        pointX = e.clientX - startX;
        pointY = e.clientY - startY;
        updateTransform();
      });

      // --- TOUCH EVENTS (Mobile Drag & Pinch Zoom) ---

      viewport.addEventListener(
        "touchstart",
        (e) => {
          if (e.touches.length === 1) {
            // Drag com um dedo
            isDragging = true;
            startX = e.touches[0].clientX - pointX;
            startY = e.touches[0].clientY - pointY;
          } else if (e.touches.length === 2) {
            // Início do Pinch (dois dedos)
            isDragging = false; // Para o drag para focar no zoom
            initialPinchDistance = getDistance(e.touches[0], e.touches[1]);
            initialScale = scale;
          }
        },
        { passive: false }
      );

      viewport.addEventListener(
        "touchmove",
        (e) => {
          e.preventDefault(); // Impede scroll da página e comportamento nativo

          if (e.touches.length === 1 && isDragging) {
            // Mover (Drag)
            pointX = e.touches[0].clientX - startX;
            pointY = e.touches[0].clientY - startY;
            updateTransform();
          } else if (e.touches.length === 2) {
            // Zoom (Pinch)
            const currentDistance = getDistance(e.touches[0], e.touches[1]);

            if (initialPinchDistance > 0) {
              const pinchRatio = currentDistance / initialPinchDistance;
              const nextScale = initialScale * pinchRatio;

              // Limites de zoom
              if (nextScale > 5 || nextScale < 0.05) return;

              // Ponto central entre os dedos
              const rect = viewport.getBoundingClientRect();
              const mid = getMidpoint(e.touches[0], e.touches[1]);
              const midX = mid.x - rect.left;
              const midY = mid.y - rect.top;

              // Matemática de zoom no ponto
              const contentX = (midX - pointX) / scale;
              const contentY = (midY - pointY) / scale;

              pointX = midX - contentX * nextScale;
              pointY = midY - contentY * nextScale;
              scale = nextScale;

              updateTransform();
            }
          }
        },
        { passive: false }
      );

      viewport.addEventListener("touchend", (e) => {
        // Se levantou um dedo mas ainda tem outro, reinicia o drag para evitar pulo
        if (e.touches.length === 1) {
          isDragging = true;
          startX = e.touches[0].clientX - pointX;
          startY = e.touches[0].clientY - pointY;
        } else {
          isDragging = false;
        }

        if (e.touches.length < 2) {
          initialPinchDistance = 0;
        }
      });
    </script>
  </body>
</html>
